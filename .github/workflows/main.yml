name: Create Tag

on:
  push:
    branches:
      - prod
      - dev

jobs:
  build:
    name: Create Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions'

      - name: Create Tag
        id: create_tag
        run: |
          VERSION_PREFIX="v"
          CURRENT_TAG=$(git describe --tags --abbrev=0)
          CURRENT_VERSION=${CURRENT_TAG#$VERSION_PREFIX}
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          if [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
            ((VERSION_PARTS[0]++))
            VERSION_PARTS[1]=0
            VERSION_PARTS[2]=0
          else
            ((VERSION_PARTS[1]++))
            VERSION_PARTS[2]=0
          fi
          NEW_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.${VERSION_PARTS[2]}"
          NEW_TAG="$VERSION_PREFIX$NEW_VERSION"
          git tag $NEW_TAG
          git push origin $NEW_TAG
          echo ::set-output name=TAG_NAME::$NEW_TAG
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create_tag.outputs.TAG_NAME }}
          release_name: Release ${{ steps.create_tag.outputs.TAG_NAME }}
          draft: false
          prerelease: false
